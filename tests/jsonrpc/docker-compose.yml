version: "3"

services:
  evmd:
    container_name: evmd-compat-test
    image: "cosmos/evmd"
    privileged: true
    user: root
    environment:
      - DEBUG=0
      - ID=0
      - LOG=${LOG:-evmd.log}
      - EVMDHOME=/data/node0/evmd
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    ports:
      - "8545:8545"
      - "8546:8546"
    volumes:
      - ./.evmd:/data:Z
      - ./scripts/evmd/container-start-evmd.sh:/container-start-evmd.sh:ro
    networks:
      - jsonrpc-test
    entrypoint: ["/bin/sh", "-c"]
    command: ["/container-start-evmd.sh"]
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --no-verbose --tries=1 --timeout=5 --post-data='{\"jsonrpc\":\"2.0\",\"method\":\"eth_chainId\",\"params\":[],\"id\":1}' --header='Content-Type: application/json' -O- http://localhost:8545 | grep -q result || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 8
      start_period: 45s

  geth:
    container_name: geth-compat-test
    image: "ethereum/client-go:latest"
    privileged: true
    ports:
      - "8547:8545"
      - "8548:8546"
    networks:
      - jsonrpc-test
    command: >
      --dev
      --dev.period 1
      --http
      --http.addr 0.0.0.0
      --http.port 8545
      --http.api eth,net,web3,personal,admin,debug,miner,txpool
      --http.corsdomain "*"
      --http.vhosts "*"
      --ws
      --ws.addr 0.0.0.0
      --ws.port 8546
      --ws.api eth,net,web3,personal,admin,debug,miner,txpool
      --ws.origins "*"
      --allow-insecure-unlock
      --rpc.allow-unprotected-txs
      --nodiscover
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  simulator:
    container_name: simulator-compat-test
    privileged: true
    build:
      context: ../../
      dockerfile: tests/jsonrpc/Dockerfile
    depends_on:
      evmd:
        condition: service_healthy
      geth:
        condition: service_healthy
    restart: on-failure
    networks:
      - jsonrpc-test
    environment:
      - EVMD_URL=http://evmd:8545
      - EVMD_WS_URL=ws://evmd:8546
      - GETH_URL=http://geth:8545
      - GETH_WS_URL=ws://geth:8546
    volumes:
      - ./simulator:/app/results:Z
    command: ["sh", "-c", "sleep 5 && ./simulator"]

networks:
  jsonrpc-test:
    driver: bridge